<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  

  
  <title>webpack4.0之简易webpack实现 | hijimo</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="完整代码 一个简单的webpack结果模版12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849(function(modules) &amp;#123;    var installedModules = &amp;#123;&amp;#125;;      function __webpack_">
<meta name="keywords" content="前端">
<meta property="og:type" content="article">
<meta property="og:title" content="webpack4.0之简易webpack实现">
<meta property="og:url" content="http://hijimo.github.io/2019/03/01/webpack4.0-简易webpack实现/index.html">
<meta property="og:site_name" content="hijimo">
<meta property="og:description" content="完整代码 一个简单的webpack结果模版12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849(function(modules) &amp;#123;    var installedModules = &amp;#123;&amp;#125;;      function __webpack_">
<meta property="og:updated_time" content="2019-03-04T07:33:55.121Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="webpack4.0之简易webpack实现">
<meta name="twitter:description" content="完整代码 一个简单的webpack结果模版12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849(function(modules) &amp;#123;    var installedModules = &amp;#123;&amp;#125;;      function __webpack_">
  
    <link rel="alternate" href="/atom.xml" title="hijimo" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png">
  
  
    <link href="//fonts.googleapis.com/css?family=Source+Code+Pro" rel="stylesheet" type="text/css">
  
  <link rel="stylesheet" href="/css/style.css">
</head>

<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">hijimo</a>
      </h1>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        
          <a id="nav-rss-link" class="nav-icon" href="/atom.xml" title="RSS Feed"></a>
        
        <a id="nav-search-btn" class="nav-icon" title="Search"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="http://hijimo.github.io"></form>
      </div>
    </div>
  </div>
</header>
      <div class="outer">
        <section id="main"><article id="post-webpack4.0-简易webpack实现" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2019/03/01/webpack4.0-简易webpack实现/" class="article-date">
  <time datetime="2019-03-01T06:25:00.000Z" itemprop="datePublished">2019-03-01</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/前端/">前端</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 class="article-title" itemprop="name">
      webpack4.0之简易webpack实现
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p><a href="!https://github.com/hijimo/easywebpack/">完整代码</a></p>
<h3 id="一个简单的webpack结果模版"><a href="#一个简单的webpack结果模版" class="headerlink" title="一个简单的webpack结果模版"></a>一个简单的webpack结果模版</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line">(function(modules) &#123;</span><br><span class="line">    var installedModules = &#123;&#125;;</span><br><span class="line">  </span><br><span class="line">    function __webpack_require__(moduleId) &#123;</span><br><span class="line">      if (installedModules[moduleId]) &#123;</span><br><span class="line">        return installedModules[moduleId].exports;</span><br><span class="line">      &#125;</span><br><span class="line">      var module = (installedModules[moduleId] = &#123;</span><br><span class="line">        i: moduleId,</span><br><span class="line">        l: false,</span><br><span class="line">        exports: &#123;&#125;</span><br><span class="line">      &#125;);</span><br><span class="line">      modules[moduleId].call(</span><br><span class="line">        module.exports,</span><br><span class="line">        module,</span><br><span class="line">        module.exports,</span><br><span class="line">        __webpack_require__</span><br><span class="line">      );</span><br><span class="line">  </span><br><span class="line">      module.l = true;</span><br><span class="line">  </span><br><span class="line">      return module.exports;</span><br><span class="line">    &#125;</span><br><span class="line">    __webpack_require__.d = function(exports, name, getter) &#123;</span><br><span class="line">      if (!__webpack_require__.o(exports, name)) &#123;</span><br><span class="line">        Object.defineProperty(exports, name, &#123; enumerable: true, get: getter &#125;);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;;</span><br><span class="line">    __webpack_require__.r = function(exports) &#123;</span><br><span class="line">      if (typeof Symbol !== &quot;undefined&quot; &amp;&amp; Symbol.toStringTag) &#123;</span><br><span class="line">        Object.defineProperty(exports, Symbol.toStringTag, &#123; value: &quot;Module&quot; &#125;);</span><br><span class="line">      &#125;</span><br><span class="line">      Object.defineProperty(exports, &quot;__esModule&quot;, &#123; value: true &#125;);</span><br><span class="line">    &#125;;</span><br><span class="line">    __webpack_require__.o = function(object, property) &#123;</span><br><span class="line">      return Object.prototype.hasOwnProperty.call(object, property);</span><br><span class="line">    &#125;;</span><br><span class="line">    return __webpack_require__((__webpack_require__.s = &quot;&lt;%- entryId%&gt;&quot;));</span><br><span class="line">  &#125;)(&#123;</span><br><span class="line">    &lt;% for (let moduleName in modules) &#123;%&gt;</span><br><span class="line">    &quot;&lt;%- moduleName%&gt;&quot;: function(module, __webpack_exports__, __webpack_require__) &#123;</span><br><span class="line">      &quot;use strict&quot;;</span><br><span class="line">      eval(</span><br><span class="line">        `&lt;%-modules[moduleName]%&gt;`</span><br><span class="line">      );</span><br><span class="line">    &#125;,</span><br><span class="line">    &lt;% &#125;%&gt;</span><br><span class="line">  </span><br><span class="line">  &#125;);</span><br></pre></td></tr></table></figure>
<a id="more"></a>
<p>简单来说， <code>webpack</code>主流程上就作了这么几件事情</p>
<ol>
<li>编译一个入口文件(代码文件)</li>
<li>解析并改造代码如将 <code>import</code>、<code>require</code>转换成 <code>__webpack_require__</code></li>
<li>收集依赖的模块并重复2</li>
<li>生成文件并导出上面的模版。</li>
</ol>
<h3 id="构建代码骨架"><a href="#构建代码骨架" class="headerlink" title="构建代码骨架"></a>构建代码骨架</h3><p>先搭建一个基本的类骨架，先不考虑<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">class Compiler&#123;</span><br><span class="line">    constructor(config) &#123;</span><br><span class="line">        // 读取webpack.config.js并初始化</span><br><span class="line">    &#125;</span><br><span class="line">    buildModule(modulePath, isEntry) &#123;</span><br><span class="line">        // 构建模块</span><br><span class="line">    &#125;</span><br><span class="line">    emitFile() &#123;</span><br><span class="line">        // 渲染模版并生成文件。</span><br><span class="line">    &#125;</span><br><span class="line">    getSource(path) &#123;</span><br><span class="line">        //读取本地文件内容</span><br><span class="line">    &#125;</span><br><span class="line">    parse(source, parentPath) &#123;</span><br><span class="line">        // 将源代码解析成 ast语法树并处理</span><br><span class="line">    &#125;</span><br><span class="line">    run() &#123;</span><br><span class="line">        // 执行并创建模块的依赖关系</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">module.exports = Compiler</span><br></pre></td></tr></table></figure></p>
<h3 id="初始化"><a href="#初始化" class="headerlink" title="初始化"></a>初始化</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">constructor(config) &#123;</span><br><span class="line">        this.config = config</span><br><span class="line">        // 保存入口文件</span><br><span class="line">        this.entryId ;</span><br><span class="line">        // 保存所有的模块依赖</span><br><span class="line">        this.modules = &#123;&#125;</span><br><span class="line">        // 工作路径</span><br><span class="line">        this.root = process.cwd()</span><br><span class="line">        this.entry = config.entry</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<h3 id="构建模块"><a href="#构建模块" class="headerlink" title="构建模块"></a>构建模块</h3><p>构建模块的基本思路</p>
<ol>
<li>读取代码文件</li>
<li>构建模块id:<code>./path/[name].[ext]</code></li>
<li>解析代码、修改代码、收集依赖。<blockquote>
<p>1.首先借助工具<code>babylon</code>将代码解析成<code>ast</code>语法树，方便处理</p>
<ol>
<li>使用工具<code>@babel/traverse</code>遍历<code>ast</code>节点</li>
<li>检测<code>require</code>，取出<code>require</code>函数的第一个参数，让它做为当前模块的依赖</li>
<li>将<code>require</code> 函数名修改成<code>__webpack_require__</code>,将<code>参数</code>修改成<code>webpack</code>支持的<code>./path/[name].[js]</code></li>
<li>将修改后的<code>ast</code>还原成代码</li>
<li>将代码和依赖列表返回</li>
</ol>
</blockquote>
</li>
</ol>
<p>4.递归依赖列表，重复以上步骤。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line">let babylon = require(&apos;babylon&apos;)</span><br><span class="line">let traverse = require(&apos;@babel/traverse&apos;).default</span><br><span class="line">let babelTyeps = require(&apos;@babel/types&apos;)</span><br><span class="line">let generator = require(&apos;@babel/generator&apos;).default</span><br><span class="line"></span><br><span class="line"> getSource(path) &#123;</span><br><span class="line">        let content = fs.readFileSync(path, &apos;utf8&apos;)</span><br><span class="line">        return content</span><br><span class="line">  &#125;</span><br><span class="line">  parse(source, parentPath) &#123;// Ast 语法解析</span><br><span class="line">        // 将源代码解析成 ast语法树</span><br><span class="line">        let deps = []</span><br><span class="line">        let ast = babylon.parse(source)</span><br><span class="line">        // 遍历ast节点</span><br><span class="line">        traverse(ast, &#123;</span><br><span class="line">            CallExpression(p) &#123;</span><br><span class="line">                let node = p.node</span><br><span class="line">                if (node.callee.name === &apos;require&apos;) &#123;</span><br><span class="line">                    node.callee.name = &apos;__webpack_require__&apos;</span><br><span class="line">                    // 构建新的模块路径(模块名)</span><br><span class="line">                    </span><br><span class="line">                    let moduleName = node.arguments[0].value</span><br><span class="line">                    // 这里作了简化处理，可能引用的还有其他模块 。</span><br><span class="line">                    moduleName = moduleName + (path.extname(moduleName) ? &apos;&apos; : &apos;.js&apos;) // ./a.js</span><br><span class="line">                    moduleName = &apos;./&apos; + path.join(parentPath, moduleName) // ./src/a.js</span><br><span class="line">                    deps.push(moduleName)</span><br><span class="line">                    // 替换node arguments 的值</span><br><span class="line">                    node.arguments = [babelTyeps.stringLiteral(moduleName)]</span><br><span class="line">                    </span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;)</span><br><span class="line">        let sourceCode = generator(ast).code</span><br><span class="line">        return &#123; sourceCode, deps&#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">  buildModule(modulePath, isEntry) &#123;</span><br><span class="line">        // 读取模块内容</span><br><span class="line">        let source = this.getSource(modulePath)</span><br><span class="line">        // 构建模块Id</span><br><span class="line">        let moduleName = &apos;./&apos; + path.relative(this.root, modulePath)</span><br><span class="line"></span><br><span class="line">        if (isEntry) &#123;</span><br><span class="line">            this.entryId = moduleName</span><br><span class="line">        &#125;</span><br><span class="line">        // 对源代码进行改造，并返回依赖列表。</span><br><span class="line">        let &#123;sourceCode, deps&#125; = this.parse(source, path.dirname(moduleName))</span><br><span class="line">        </span><br><span class="line">        this.modules[moduleName] = sourceCode</span><br><span class="line">        // 递归加载依赖模块。</span><br><span class="line">        deps.forEach((dep) =&gt; &#123;</span><br><span class="line">            this.buildModule(path.join(this.root, dep), false)</span><br><span class="line">        &#125;)</span><br><span class="line">        </span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<h3 id="导出文件"><a href="#导出文件" class="headerlink" title="导出文件"></a>导出文件</h3><p>基本思路,使用 <code>ejs</code>模版，将模块信息填充进去</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">emitFile() &#123;</span><br><span class="line">        // 渲染模版并生成文件。</span><br><span class="line">        let &#123; output &#125; = this.config</span><br><span class="line">        let main = path.join(output.path, output.filename)</span><br><span class="line">        let tpl = this.getSource(&apos;./src/tpl.ejs&apos;)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        let code = ejs.render(tpl, &#123;</span><br><span class="line">            entryId: this.entryId,</span><br><span class="line">            modules: this.modules,</span><br><span class="line">        &#125;)</span><br><span class="line">        this.assets = &#123;&#125;</span><br><span class="line">        this.assets[main] = code;</span><br><span class="line">        fs.writeFileSync(main, code)</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<h3 id="爆露一个执行方法"><a href="#爆露一个执行方法" class="headerlink" title="爆露一个执行方法"></a>爆露一个执行方法</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">run() &#123;</span><br><span class="line">        // 执行并创建模块的依赖关系</span><br><span class="line">        this.buildModule(path.resolve(this.root, this.entry), true)</span><br><span class="line">        // 发射 打包后的文件。</span><br><span class="line">        this.emitFile()</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<h3 id="扩展loader"><a href="#扩展loader" class="headerlink" title="扩展loader"></a>扩展loader</h3><p>以上就完成了主流程的代码，下面来扩张<code>webpack</code>的<code>loader</code>。<br>首先，loader所作的事情就是在加载文件时匹配<code>hash</code>,如果正则匹配则调用<code>loader</code>去处理它并返回处理后的结果。</p>
<p>那么，先改造一下 <code>getSource</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">getSource(path) &#123;</span><br><span class="line">        let content = fs.readFileSync(path, &apos;utf8&apos;)</span><br><span class="line">        // return content</span><br><span class="line">        return this.progressLoaders(path, content)</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>再来实现 <code>this.progressLoaders</code>方法。<br><code>loader</code>有几个注意事项：</p>
<ol>
<li><code>loader</code> 是一个数组并从下往上执行</li>
<li>每一个<code>loader</code>的执行结果都会返回给下一个待执行的<code>loader</code></li>
<li><code>loader</code>是一个可执行函数。</li>
</ol>
<p>那么思路就很清晰了，只要在正则匹配之后依次执行数组里的<code>loader</code>即可。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">progressLoaders(modulePath, content)&#123;</span><br><span class="line">        let rules = this.config.module.rules</span><br><span class="line"></span><br><span class="line">        rules.forEach((rule) =&gt; &#123;</span><br><span class="line">            const &#123; test:match, use&#125; = rule</span><br><span class="line">            let len = use.length - 1</span><br><span class="line">            </span><br><span class="line">            function normalLoader() &#123;</span><br><span class="line">                let p = use[len]</span><br><span class="line">                let moduleName = p.loader ? p.loader : p</span><br><span class="line">                let loader = require(moduleName) </span><br><span class="line">                content = loader(content)</span><br><span class="line">                </span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            if (match.test(modulePath)) &#123;</span><br><span class="line">                </span><br><span class="line">                do &#123;</span><br><span class="line">                    normalLoader()    </span><br><span class="line">                    len--</span><br><span class="line">                    </span><br><span class="line">                &#125; while (len &gt;= 0)</span><br><span class="line">                </span><br><span class="line">            &#125;</span><br><span class="line">        &#125;)</span><br><span class="line">        </span><br><span class="line">        return content</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure></p>
<h3 id="扩展plugins"><a href="#扩展plugins" class="headerlink" title="扩展plugins"></a>扩展plugins</h3><p>插件即钩子，插件的实现就很简单了。只要在<code>constructor</code>的时候添初始化钩子，然后在合适的地方调用即可。</p>
<ol>
<li>改造 <code>constructor</code></li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">constructor(config) &#123;</span><br><span class="line">        this.config = config</span><br><span class="line">        // 保存入口文件</span><br><span class="line">        this.entryId ;</span><br><span class="line">        // 保存所有的模块依赖</span><br><span class="line">        this.modules = &#123;&#125;</span><br><span class="line">        // 工作路径</span><br><span class="line">        this.root = process.cwd()</span><br><span class="line">        this.entry = config.entry</span><br><span class="line">        this.initHooks()</span><br><span class="line">        this.progressPlugins()</span><br><span class="line"> &#125;</span><br><span class="line">initHooks() &#123;</span><br><span class="line">	// 配置钩子</span><br><span class="line">        this.hooks = &#123;</span><br><span class="line">            entryOption: new SyncHook(),</span><br><span class="line">            compile: new SyncHook(),</span><br><span class="line">            afterCompile: new SyncHook(),</span><br><span class="line">            afterPlugins: new SyncHook(),</span><br><span class="line">            run: new SyncHook(),</span><br><span class="line">            emit: new SyncHook(),</span><br><span class="line">            done: new SyncHook()</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    progressPlugins() &#123;</span><br><span class="line">        // 初始化用户配置插件</span><br><span class="line">        // 挂载钩子函数</span><br><span class="line">        let &#123; plugins &#125; = this.config</span><br><span class="line">        if (Array.isArray(plugins)) &#123;</span><br><span class="line"></span><br><span class="line">            plugins.forEach((plugin) =&gt; &#123;</span><br><span class="line">                plugin.apply(this)</span><br><span class="line">            &#125;)</span><br><span class="line">            this.hooks.afterPlugins.call(this)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<ol>
<li>在合适的地方调用钩子</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">run() &#123;</span><br><span class="line">        // 执行并创建模块的依赖关系</span><br><span class="line">        this.hooks.run.call(this)</span><br><span class="line">        this.hooks.compile.call(this)</span><br><span class="line">        this.buildModule(path.resolve(this.root, this.entry), true)</span><br><span class="line">        this.hooks.afterCompile.call(this)</span><br><span class="line">        // 发射 打包后的文件。</span><br><span class="line">        this.emitFile()</span><br><span class="line">        this.hooks.emit.call(this)</span><br><span class="line">        this.hooks.done.call(this)</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://hijimo.github.io/2019/03/01/webpack4.0-简易webpack实现/" data-id="cjsu13c88001qrd3gd9d8cy5h" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/前端/">前端</a></li></ul>

    </footer>
  </div>
  
    
<nav id="article-nav">
  
    <a href="/2019/03/03/headers头和文件下载/" id="article-nav-newer" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Newer</strong>
      <div class="article-nav-title">
        
          headers头和文件下载
        
      </div>
    </a>
  
  
    <a href="/2019/02/25/webpack4.0-插件/" id="article-nav-older" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Older</strong>
      <div class="article-nav-title">webpack4.0之插件</div>
    </a>
  
</nav>

  
</article>

</section>
        
          <aside id="sidebar">
  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Categories</h3>
    <div class="widget">
      <ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/前端/">前端</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/前端优化/">前端优化</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tags</h3>
    <div class="widget">
      <ul class="tag-list"><li class="tag-list-item"><a class="tag-list-link" href="/tags/composite/">composite</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/css/">css</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/cssom/">cssom</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/dom/">dom</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/javascript/">javascript</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/webRTC/">webRTC</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/分析/">分析</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/前端/">前端</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/前端优化/">前端优化</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/压缩/">压缩</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/图片/">图片</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/帧/">帧</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/性能/">性能</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/渲染/">渲染</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/移动/">移动</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/缓存/">缓存</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tag Cloud</h3>
    <div class="widget tagcloud">
      <a href="/tags/composite/" style="font-size: 10px;">composite</a> <a href="/tags/css/" style="font-size: 12px;">css</a> <a href="/tags/cssom/" style="font-size: 10px;">cssom</a> <a href="/tags/dom/" style="font-size: 10px;">dom</a> <a href="/tags/javascript/" style="font-size: 12px;">javascript</a> <a href="/tags/webRTC/" style="font-size: 14px;">webRTC</a> <a href="/tags/分析/" style="font-size: 10px;">分析</a> <a href="/tags/前端/" style="font-size: 20px;">前端</a> <a href="/tags/前端优化/" style="font-size: 18px;">前端优化</a> <a href="/tags/压缩/" style="font-size: 10px;">压缩</a> <a href="/tags/图片/" style="font-size: 10px;">图片</a> <a href="/tags/帧/" style="font-size: 10px;">帧</a> <a href="/tags/性能/" style="font-size: 12px;">性能</a> <a href="/tags/渲染/" style="font-size: 16px;">渲染</a> <a href="/tags/移动/" style="font-size: 10px;">移动</a> <a href="/tags/缓存/" style="font-size: 10px;">缓存</a>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Archives</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/03/">March 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/02/">February 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/01/">January 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/10/">October 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/09/">September 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/05/">May 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/03/">March 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/06/">June 2016</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/08/">August 2015</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/03/">March 2015</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/02/">February 2015</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2014/07/">July 2014</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Recent Posts</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2019/03/03/headers头和文件下载/">headers头和文件下载</a>
          </li>
        
          <li>
            <a href="/2019/03/01/webpack4.0-简易webpack实现/">webpack4.0之简易webpack实现</a>
          </li>
        
          <li>
            <a href="/2019/02/25/webpack4.0-插件/">webpack4.0之插件</a>
          </li>
        
          <li>
            <a href="/2019/02/24/webpack4.0--tapable/">webpack4.0之tapable</a>
          </li>
        
          <li>
            <a href="/2019/02/22/webpack4.0--loader/">webpack4.0之loader</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      &copy; 2019 山民<br>
      Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>
    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
</nav>
    

<script src="//ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>


  <link rel="stylesheet" href="/fancybox/jquery.fancybox.css">
  <script src="/fancybox/jquery.fancybox.pack.js"></script>


<script src="/js/script.js"></script>



  </div>
</body>
</html>